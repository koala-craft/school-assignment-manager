# 学校提出物管理アプリ 環境構築手順書

本手順書では、開発環境の構築からアプリケーションの起動までを、初心者でも実行できるよう詳細に説明します。

---

## 目次

1. [前提条件](#1-前提条件)
2. [必要なソフトウェアのインストール](#2-必要なソフトウェアのインストール)
3. [プロジェクトのセットアップ](#3-プロジェクトのセットアップ)
4. [バックエンド環境構築](#4-バックエンド環境構築)
5. [フロントエンド環境構築](#5-フロントエンド環境構築)
6. [データベースセットアップ](#6-データベースセットアップ)
7. [アプリケーションの起動](#7-アプリケーションの起動)
8. [動作確認](#8-動作確認)
9. [トラブルシューティング](#9-トラブルシューティング)

---

## 1. 前提条件

### 1.1 必要なスペック

* **OS**: Windows 10/11、macOS 12以上、Ubuntu 20.04以上
* **CPU**: 2コア以上
* **メモリ**: 8GB以上（推奨：16GB）
* **ストレージ**: 20GB以上の空き容量

### 1.2 事前知識

* 基本的なコマンドライン操作
* Gitの基本操作
* テキストエディタの使用方法

---

## 2. 必要なソフトウェアのインストール

### 2.1 Git のインストール

#### Windows の場合

1. [Git公式サイト](https://git-scm.com/download/win) から最新版をダウンロード
2. ダウンロードしたインストーラーを実行
3. インストールオプションは基本的にデフォルトのままでOK
4. インストール完了後、PowerShellまたはコマンドプロンプトで以下を実行して確認

```bash
git --version
```

#### macOS の場合

1. Homebrewがインストールされていない場合は、まずHomebrewをインストール

```bash
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
```

2. Gitをインストール

```bash
brew install git
```

3. バージョン確認

```bash
git --version
```

#### Linux (Ubuntu/Debian) の場合

```bash
sudo apt update
sudo apt install git -y
git --version
```

### 2.2 Docker Desktop のインストール

#### Windows の場合

1. [Docker Desktop for Windows](https://www.docker.com/products/docker-desktop/) からダウンロード
2. インストーラーを実行
3. インストール完了後、システムを再起動
4. Docker Desktopを起動
5. 確認コマンド

```bash
docker --version
docker compose version
```

**注意**: Windows HomeエディションでWSL 2が必要な場合があります。

#### macOS の場合

1. [Docker Desktop for Mac](https://www.docker.com/products/docker-desktop/) からダウンロード
2. ダウンロードした.dmgファイルを開き、Dockerアイコンをアプリケーションフォルダにドラッグ
3. アプリケーションフォルダからDockerを起動
4. 確認コマンド

```bash
docker --version
docker compose version
```

#### Linux の場合

```bash
# Docker のインストール
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# ユーザーをdockerグループに追加
sudo usermod -aG docker $USER

# 再ログインまたは以下を実行
newgrp docker

# Docker Compose のインストール
sudo apt install docker-compose-plugin -y

# 確認
docker --version
docker compose version
```

### 2.3 Node.js のインストール

フロントエンド開発に必要です。

#### すべてのOSで共通（推奨方法）

Node Version Manager (nvm) を使用します。

**Windows の場合:**

1. [nvm-windows](https://github.com/coreybutler/nvm-windows/releases) から最新版をダウンロード
2. インストーラーを実行
3. インストール完了後、新しいコマンドプロンプトを開いて以下を実行

```bash
nvm install 20
nvm use 20
node --version
npm --version
```

**macOS / Linux の場合:**

```bash
# nvmのインストール
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash

# ターミナルを再起動または以下を実行
source ~/.bashrc  # または source ~/.zshrc (macOSの場合)

# Node.js 20をインストール
nvm install 20
nvm use 20

# 確認
node --version
npm --version
```

### 2.4 Composer のインストール (オプション)

Dockerコンテナ内でも使用できますが、ローカルにあると便利です。

#### Windows の場合

1. [Composer公式サイト](https://getcomposer.org/download/) からインストーラーをダウンロード
2. インストーラーを実行

#### macOS / Linux の場合

```bash
# Composerのダウンロードとインストール
php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
php composer-setup.php
php -r "unlink('composer-setup.php');"
sudo mv composer.phar /usr/local/bin/composer

# 確認
composer --version
```

### 2.5 テキストエディタ / IDE のインストール

推奨: Visual Studio Code

1. [Visual Studio Code公式サイト](https://code.visualstudio.com/) からダウンロード
2. インストール
3. 推奨拡張機能のインストール
   * PHP Intelephense
   * Laravel Extension Pack
   * Vue - Official
   * ESLint
   * Prettier
   * Docker

---

## 3. プロジェクトのセットアップ

### 3.1 プロジェクトディレクトリの作成

```bash
# 作業用ディレクトリに移動（例）
cd ~/projects

# プロジェクトディレクトリを作成
mkdir school-assignment-app
cd school-assignment-app
```

### 3.2 Gitリポジトリの初期化

```bash
# Gitリポジトリの初期化
git init

# .gitignoreファイルの作成
cat > .gitignore << 'EOF'
# Laravel
/backend/vendor/
/backend/node_modules/
/backend/public/hot
/backend/public/storage
/backend/storage/*.key
/backend/.env
/backend/.phpunit.result.cache
/backend/Homestead.json
/backend/Homestead.yaml
/backend/npm-debug.log
/backend/yarn-error.log

# Vue
/frontend/node_modules/
/frontend/dist/
/frontend/.env.local
/frontend/.env.*.local
/frontend/npm-debug.log*
/frontend/yarn-debug.log*
/frontend/yarn-error.log*

# Docker
/docker/postgres/data/
/docker/redis/data/

# IDE
.vscode/
.idea/
*.swp
*.swo
*~

# OS
.DS_Store
Thumbs.db
EOF
```

### 3.3 プロジェクト構造の作成

```bash
# ディレクトリ構造を作成
mkdir -p backend
mkdir -p frontend
mkdir -p docker/nginx
mkdir -p docker/php
mkdir -p docker/postgres
mkdir -p docker/redis
```

**Windows PowerShellの場合:**

```powershell
# PowerShellでは以下のように実行
New-Item -ItemType Directory -Path backend -Force
New-Item -ItemType Directory -Path frontend -Force
New-Item -ItemType Directory -Path docker\nginx -Force
New-Item -ItemType Directory -Path docker\php -Force
New-Item -ItemType Directory -Path docker\postgres -Force
New-Item -ItemType Directory -Path docker\redis -Force
```

---

## 4. バックエンド環境構築

### 4.0 簡単セットアップ（推奨）

**注意**: Docker、Node.js、Gitのインストールが完了している必要があります。

プロジェクトルートに用意されているセットアップスクリプトを使用すると、以下の手順4.1〜4.7を自動で実行できます。

#### Windows PowerShell の場合（推奨）

```powershell
# プロジェクトルートで実行
.\scripts\setup-backend.ps1
```

**初回実行時にエラーが出る場合**: PowerShellの実行ポリシーを変更する必要があります

```powershell
# 管理者権限でPowerShellを開いて実行
Set-ExecutionPolicy RemoteSigned -Scope CurrentUser
```

#### コマンドプロンプト の場合

```cmd
# プロジェクトルートで実行
scripts\setup-backend.bat
```

#### セットアップスクリプトの内容

以下の処理を自動で実行します：

1. Dockerイメージのビルド
2. Dockerコンテナの起動
3. Laravel Sanctumのインストール
4. Sanctum設定ファイルの公開
5. データベースマイグレーション
6. Laravel Pintのインストール
7. Laravel Telescopeのインストール
8. PHPStanのインストール

**セットアップ完了後、以下のURLでアクセスできます：**

- バックエンドAPI: http://localhost:8000
- Mailpit（メールテスト）: http://localhost:8025
- Telescope（デバッグツール）: http://localhost:8000/telescope

---

### 4.1 手動セットアップ（詳細版）

上記の自動セットアップがうまくいかない場合や、各ステップを詳しく理解したい場合は、以下の手動手順を実行してください。

#### 4.1.1 Laravelプロジェクトの作成

Dockerコンテナ内でLaravelをセットアップします。

**注意**: 以下のファイルは自動セットアップスクリプトを実行した場合、既に作成されています。

#### Step 1: Docker Compose ファイルの作成（既に作成済みの場合はスキップ）

プロジェクトルートに `docker-compose.yml` を作成:

```yaml
version: '3.8'

services:
  # PostgreSQL データベース
  postgres:
    image: postgres:15-alpine
    container_name: school-app-db
    restart: unless-stopped
    environment:
      POSTGRES_DB: school_assignment_db
      POSTGRES_USER: school_user
      POSTGRES_PASSWORD: school_password
    volumes:
      - ./docker/postgres/data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    networks:
      - school-app-network

  # Redis キャッシュ/キュー
  redis:
    image: redis:7-alpine
    container_name: school-app-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - ./docker/redis/data:/data
    networks:
      - school-app-network

  # PHP-FPM (Laravel)
  app:
    build:
      context: ./docker/php
      dockerfile: Dockerfile
    container_name: school-app-backend
    restart: unless-stopped
    working_dir: /var/www
    volumes:
      - ./backend:/var/www
    environment:
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_DATABASE=school_assignment_db
      - DB_USERNAME=school_user
      - DB_PASSWORD=school_password
      - REDIS_HOST=redis
    depends_on:
      - postgres
      - redis
    networks:
      - school-app-network

  # Nginx Webサーバー
  nginx:
    image: nginx:alpine
    container_name: school-app-nginx
    restart: unless-stopped
    ports:
      - "8000:80"
    volumes:
      - ./backend:/var/www
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - app
    networks:
      - school-app-network

  # Mailpit (開発用メールサーバー)
  mailpit:
    image: axllent/mailpit
    container_name: school-app-mailpit
    restart: unless-stopped
    ports:
      - "8025:8025"
      - "1025:1025"
    networks:
      - school-app-network

networks:
  school-app-network:
    driver: bridge
```

#### Step 2: PHP Dockerfile の作成

`docker/php/Dockerfile` を作成:

```dockerfile
FROM php:8.2-fpm-alpine

# 必要なパッケージのインストール
RUN apk add --no-cache \
    postgresql-dev \
    libzip-dev \
    zip \
    unzip \
    git \
    curl

# PHP拡張機能のインストール
RUN docker-php-ext-install \
    pdo_pgsql \
    pgsql \
    zip \
    pcntl \
    bcmath

# Composerのインストール
COPY --from=composer:latest /usr/bin/composer /usr/bin/composer

# 作業ディレクトリの設定
WORKDIR /var/www

# 権限設定
RUN chown -R www-data:www-data /var/www

USER www-data
```

#### Step 3: Nginx 設定ファイルの作成

`docker/nginx/default.conf` を作成:

```nginx
server {
    listen 80;
    server_name localhost;
    root /var/www/public;

    index index.php index.html;

    charset utf-8;

    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    location = /favicon.ico { access_log off; log_not_found off; }
    location = /robots.txt  { access_log off; log_not_found off; }

    error_page 404 /index.php;

    location ~ \.php$ {
        fastcgi_pass app:9000;
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        include fastcgi_params;
    }

    location ~ /\.(?!well-known).* {
        deny all;
    }
}
```

#### Step 4: Laravelプロジェクトの作成

```bash
# まずDockerイメージをビルド
docker compose build app

# Dockerコンテナを一時的に起動してLaravelをインストール
docker compose run --rm app composer create-project laravel/laravel .

# 権限の調整（Linux/macOSの場合）
sudo chown -R $USER:$USER backend/

# Windowsの場合は権限調整不要
```

**注意（重要）**: 

* Composerのメモリ不足エラーが発生した場合:

```bash
# メモリ制限を解除してインストール
docker compose run --rm app composer create-project laravel/laravel . --ignore-platform-reqs
```

* または、docker/php/Dockerfileに以下を追加:

```dockerfile
# メモリ制限の設定
RUN echo "memory_limit = 512M" > /usr/local/etc/php/conf.d/memory-limit.ini
```

#### Step 5: Laravel環境設定

`backend/.env` を編集:

```env
APP_NAME="学校提出物管理アプリ"
APP_ENV=local
APP_KEY=
APP_DEBUG=true
APP_URL=http://localhost:8000

LOG_CHANNEL=stack
LOG_LEVEL=debug

DB_CONNECTION=pgsql
DB_HOST=postgres
DB_PORT=5432
DB_DATABASE=school_assignment_db
DB_USERNAME=school_user
DB_PASSWORD=school_password

BROADCAST_DRIVER=log
CACHE_DRIVER=redis
FILESYSTEM_DISK=local
QUEUE_CONNECTION=redis
SESSION_DRIVER=redis
SESSION_LIFETIME=120

REDIS_HOST=redis
REDIS_PASSWORD=null
REDIS_PORT=6379

MAIL_MAILER=smtp
MAIL_HOST=mailpit
MAIL_PORT=1025
MAIL_USERNAME=null
MAIL_PASSWORD=null
MAIL_ENCRYPTION=null
MAIL_FROM_ADDRESS="noreply@school-app.local"
MAIL_FROM_NAME="${APP_NAME}"
```

#### Step 6: アプリケーションキーの生成

```bash
# Dockerコンテナ内で実行
docker compose exec app php artisan key:generate
```

#### Step 7: 必要なLaravelパッケージのインストール

```bash
# Laravel Sanctum (API認証)
docker compose exec app composer require laravel/sanctum

# Sanctumの設定ファイルを公開
docker compose exec app php artisan vendor:publish --provider="Laravel\Sanctum\SanctumServiceProvider"

# Sanctumのマイグレーション実行
docker compose exec app php artisan migrate

# Laravel Pint (コードフォーマッター)
docker compose exec app composer require laravel/pint --dev

# Laravel Telescope (デバッグツール、開発環境のみ)
docker compose exec app composer require laravel/telescope --dev
docker compose exec app php artisan telescope:install
docker compose exec app php artisan migrate

# PHPStan (静的解析、開発環境のみ)
docker compose exec app composer require phpstan/phpstan --dev
```

#### Step 8: CORS設定（重要）

フロントエンドからAPIにアクセスするためのCORS設定を行います。

`backend/config/cors.php` を編集:

```php
return [
    'paths' => ['api/*', 'sanctum/csrf-cookie'],
    'allowed_methods' => ['*'],
    'allowed_origins' => [
        'http://localhost:3000',  // フロントエンドのURL
    ],
    'allowed_origins_patterns' => [],
    'allowed_headers' => ['*'],
    'exposed_headers' => [],
    'max_age' => 0,
    'supports_credentials' => true,
];
```

`backend/config/sanctum.php` を編集:

```php
'stateful' => explode(',', env('SANCTUM_STATEFUL_DOMAINS', sprintf(
    '%s%s',
    'localhost,localhost:3000,127.0.0.1,127.0.0.1:8000,::1',
    env('APP_URL') ? ','.parse_url(env('APP_URL'), PHP_URL_HOST) : ''
))),
```

`backend/.env` に追加:

```env
SANCTUM_STATEFUL_DOMAINS=localhost:3000
SESSION_DOMAIN=localhost
```

---

## 5. フロントエンド環境構築

### 5.1 Vueプロジェクトの作成

```bash
# frontendディレクトリに移動
cd frontend

# Viteを使用してVue 3プロジェクトを作成
npm create vite@latest . -- --template vue-ts

# 依存関係のインストール
npm install
```

### 5.2 必要なパッケージのインストール

```bash
# Vue Router
npm install vue-router@4

# Pinia (状態管理)
npm install pinia

# Axios (HTTP通信)
npm install axios

# Vuetify (UIコンポーネント)
npm install vuetify@next @mdi/font

# VeeValidate (バリデーション)
npm install vee-validate yup

# 日付処理
npm install dayjs

# 開発用ツール
npm install -D @vue/eslint-config-typescript
npm install -D eslint prettier eslint-plugin-vue
npm install -D @types/node
```

### 5.3 環境設定ファイルの作成

`frontend/.env` を作成:

```env
VITE_API_BASE_URL=http://localhost:8000/api
VITE_APP_NAME=学校提出物管理アプリ
```

### 5.4 プロキシ設定（開発環境用）

`frontend/vite.config.ts` を編集:

```typescript
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'
import { fileURLToPath, URL } from 'node:url'

export default defineConfig({
  plugins: [vue()],
  resolve: {
    alias: {
      '@': fileURLToPath(new URL('./src', import.meta.url))
    }
  },
  server: {
    port: 3000,
    proxy: {
      '/api': {
        target: 'http://localhost:8000',
        changeOrigin: true,
      }
    }
  }
})
```

### 5.5 基本的なディレクトリ構造の作成

```bash
# frontendディレクトリ内で実行
mkdir -p src/api
mkdir -p src/components
mkdir -p src/views
mkdir -p src/router
mkdir -p src/stores
mkdir -p src/types
mkdir -p src/utils
mkdir -p src/composables
```

### 5.6 Vuetifyのセットアップ

Vuetifyを使用する場合の詳細な設定手順です。

#### Step 1: Vuetifyプラグインファイルの作成

`frontend/src/plugins/vuetify.ts` を作成:

```typescript
import 'vuetify/styles'
import { createVuetify } from 'vuetify'
import * as components from 'vuetify/components'
import * as directives from 'vuetify/directives'
import '@mdi/font/css/materialdesignicons.css'

export default createVuetify({
  components,
  directives,
  theme: {
    defaultTheme: 'light',
    themes: {
      light: {
        colors: {
          primary: '#1976D2',
          secondary: '#424242',
          accent: '#82B1FF',
          error: '#FF5252',
          info: '#2196F3',
          success: '#4CAF50',
          warning: '#FB8C00',
        }
      }
    }
  }
})
```

#### Step 2: main.tsにVuetifyを追加

`frontend/src/main.ts` を編集:

```typescript
import { createApp } from 'vue'
import { createPinia } from 'pinia'
import App from './App.vue'
import router from './router'
import vuetify from './plugins/vuetify'

const app = createApp(App)

app.use(createPinia())
app.use(router)
app.use(vuetify)

app.mount('#app')
```

### 5.7 Axiosのセットアップ

API通信用のAxios設定を行います。

`frontend/src/api/axios.ts` を作成:

```typescript
import axios from 'axios'

const apiClient = axios.create({
  baseURL: import.meta.env.VITE_API_BASE_URL || 'http://localhost:8000/api',
  withCredentials: true,
  headers: {
    'Content-Type': 'application/json',
    'Accept': 'application/json'
  }
})

// リクエストインターセプター
apiClient.interceptors.request.use(
  (config) => {
    // 必要に応じてトークンを追加
    const token = localStorage.getItem('auth_token')
    if (token) {
      config.headers.Authorization = `Bearer ${token}`
    }
    return config
  },
  (error) => {
    return Promise.reject(error)
  }
)

// レスポンスインターセプター
apiClient.interceptors.response.use(
  (response) => response,
  (error) => {
    if (error.response?.status === 401) {
      // 認証エラー時の処理
      localStorage.removeItem('auth_token')
      window.location.href = '/login'
    }
    return Promise.reject(error)
  }
)

export default apiClient
```

### 5.8 Vue Routerのセットアップ

`frontend/src/router/index.ts` を作成:

```typescript
import { createRouter, createWebHistory } from 'vue-router'

const router = createRouter({
  history: createWebHistory(import.meta.env.BASE_URL),
  routes: [
    {
      path: '/',
      name: 'home',
      component: () => import('../views/HomeView.vue')
    },
    {
      path: '/login',
      name: 'login',
      component: () => import('../views/LoginView.vue')
    },
    // 他のルートは実装時に追加
  ]
})

// ナビゲーションガード
router.beforeEach((to, from, next) => {
  const isAuthenticated = !!localStorage.getItem('auth_token')
  
  if (to.name !== 'login' && !isAuthenticated) {
    next({ name: 'login' })
  } else {
    next()
  }
})

export default router
```

---

## 6. データベースセットアップ

### 6.1 Dockerコンテナの起動

```bash
# プロジェクトルートで実行
docker compose up -d

# コンテナが起動していることを確認
docker compose ps
```

### 6.2 データベースマイグレーション

#### Step 1: マイグレーションファイルの作成

今後、以下のようなマイグレーションを作成していきます:

```bash
# ユーザーテーブル（Laravelデフォルトを拡張）
docker compose exec app php artisan make:migration add_role_to_users_table

# 年度テーブル
docker compose exec app php artisan make:migration create_academic_years_table

# 学期テーブル
docker compose exec app php artisan make:migration create_terms_table

# 科目テーブル
docker compose exec app php artisan make:migration create_subjects_table

# 履修テーブル
docker compose exec app php artisan make:migration create_enrollments_table

# 提出物テーブル
docker compose exec app php artisan make:migration create_assignments_table

# 提出状況テーブル
docker compose exec app php artisan make:migration create_submissions_table

# 提出履歴テーブル
docker compose exec app php artisan make:migration create_submission_histories_table
```

#### Step 2: マイグレーションの実行

```bash
# マイグレーション実行
docker compose exec app php artisan migrate

# ロールバック（必要な場合）
docker compose exec app php artisan migrate:rollback

# マイグレーションのリセット（全削除＋再実行）
docker compose exec app php artisan migrate:fresh
```

### 6.3 シーダーの作成と実行

```bash
# シーダーファイルの作成
docker compose exec app php artisan make:seeder DatabaseSeeder
docker compose exec app php artisan make:seeder UserSeeder
docker compose exec app php artisan make:seeder AcademicYearSeeder
docker compose exec app php artisan make:seeder SubjectSeeder

# シーダーの実行
docker compose exec app php artisan db:seed

# マイグレーション＋シーダーを一度に実行
docker compose exec app php artisan migrate:fresh --seed
```

---

## 7. アプリケーションの起動

### 7.1 バックエンドの起動

バックエンドはDockerで起動済みですが、確認します:

```bash
# プロジェクトルートで実行
docker compose up -d

# ログの確認
docker compose logs -f app

# Laravelのキャッシュクリア
docker compose exec app php artisan cache:clear
docker compose exec app php artisan config:clear
docker compose exec app php artisan route:clear
```

### 7.2 フロントエンドの起動

```bash
# frontendディレクトリで実行
cd frontend
npm run dev
```

フロントエンドは `http://localhost:3000` で起動します。

### 7.3 キュー処理の起動（バックグラウンド処理用）

```bash
# 別のターミナルで実行
docker compose exec app php artisan queue:work
```

### 7.4 タスクスケジューラーの起動（定期実行タスク用）

開発環境では手動実行で確認できます:

```bash
docker compose exec app php artisan schedule:run
```

本番環境では、Cronに以下を設定:

```bash
* * * * * cd /var/www && php artisan schedule:run >> /dev/null 2>&1
```

---

## 8. 動作確認

**詳細な動作確認手順は [動作確認手順書](./動作確認手順書.md) を参照してください。** 各機能（個人成績表PDF、パスワードリセットなど）の動作確認に必要な設定は [開発時の注意事項](./開発時の注意事項.md) も参照してください。ここでは基本的な確認のみ記載します。

### 8.1 バックエンドの動作確認

#### ブラウザで確認

1. `http://localhost:8000` にアクセス
2. Laravelのウェルカムページが表示されればOK

#### API動作確認（自動テストスクリプト）

プロジェクトルートで以下の PowerShell スクリプトを実行することで、各 API の動作を確認できます。

```powershell
# 認証APIの確認
.\scripts\test-api.ps1

# ユーザー管理APIの確認
.\scripts\test-user-api.ps1

# その他: test-academic-api.ps1, test-subject-api.ps1, test-assignment-api.ps1 など
```

全テストスクリプトの一覧と詳細は [動作確認手順書](./動作確認手順書.md) を参照してください。

#### API動作確認（手動）

```bash
# ヘルスチェックエンドポイント
curl http://localhost:8000/api/health

# 認証エンドポイント
curl http://localhost:8000/api/auth/login
```

### 8.2 データベースの動作確認

```bash
# PostgreSQLに接続
docker compose exec postgres psql -U school_user -d school_assignment_db

# テーブル一覧を表示
\dt

# 特定のテーブルの構造を確認
\d users

# データを確認
SELECT * FROM users;

# 終了
\q
```

### 8.2.1 データベースGUIツールでの接続

より視覚的にデータベースを管理したい場合、GUIツールを使用できます。

#### DBeaver の接続設定例

1. DBeaver を起動
2. 新規接続 → PostgreSQL を選択
3. 以下の情報を入力:
   * **Host**: localhost
   * **Port**: 5432
   * **Database**: school_assignment_db
   * **Username**: school_user
   * **Password**: school_password
4. 「接続テスト」をクリックして確認
5. 「完了」をクリック

#### pgAdmin の接続設定例

1. pgAdmin を起動
2. サーバー追加
3. 以下の情報を入力:
   * **Name**: School Assignment DB (任意)
   * **Host**: localhost
   * **Port**: 5432
   * **Maintenance database**: school_assignment_db
   * **Username**: school_user
   * **Password**: school_password
4. 保存

#### TablePlus の接続設定例

1. TablePlus を起動
2. 新規接続 → PostgreSQL
3. 以下の情報を入力:
   * **Host**: localhost
   * **Port**: 5432
   * **User**: school_user
   * **Password**: school_password
   * **Database**: school_assignment_db
4. Test をクリックして確認
5. Connect をクリック

### 8.3 フロントエンドの動作確認

1. `http://localhost:3000` にアクセス
2. Vueアプリケーションが表示されればOK

### 8.4 Mailpit（メールテスト）の確認

1. `http://localhost:8025` にアクセス
2. Mailpitの管理画面が表示されればOK
3. アプリから送信されたメールがここに表示されます

### 8.5 Redis の動作確認

```bash
# Redisに接続
docker compose exec redis redis-cli

# 接続テスト
PING
# 「PONG」と返ってくればOK

# 終了
exit
```

---

## 9. トラブルシューティング

### 9.1 Dockerコンテナが起動しない

#### 問題: ポートが既に使用されている

```bash
# 使用中のポートを確認 (Windows)
netstat -ano | findstr :8000
netstat -ano | findstr :5432

# 使用中のポートを確認 (macOS/Linux)
lsof -i :8000
lsof -i :5432

# 対処法: docker-compose.ymlでポート番号を変更
# 例: "8000:80" → "8080:80"
```

#### 問題: Docker Desktopが起動していない

- Windows/macOS: Docker Desktopアプリケーションを起動する
- Linux: Docker daemonが起動しているか確認

```bash
sudo systemctl status docker
sudo systemctl start docker
```

### 9.2 データベース接続エラー

#### 問題: Connection refused

```bash
# PostgreSQLコンテナが起動しているか確認
docker compose ps

# PostgreSQLコンテナのログを確認
docker compose logs postgres

# コンテナの再起動
docker compose restart postgres
```

#### 問題: 認証エラー

- `backend/.env` の DB設定を確認
- `docker-compose.yml` のPostgreSQL環境変数と一致しているか確認

### 9.3 マイグレーションエラー

#### 問題: Class not found

```bash
# Composerのオートロードを再生成
docker compose exec app composer dump-autoload

# キャッシュをクリア
docker compose exec app php artisan cache:clear
docker compose exec app php artisan config:clear
```

#### 問題: Already exists エラー

```bash
# マイグレーションをリセット
docker compose exec app php artisan migrate:fresh

# 注意: 全データが削除されます
```

### 9.4 フロントエンド起動エラー

#### 問題: Module not found

```bash
# node_modulesを削除して再インストール
cd frontend
rm -rf node_modules package-lock.json
npm install
```

#### 問題: ポート3000が既に使用中

```bash
# vite.config.tsでポート番号を変更
# server.port を 3001 など別のポートに変更
```

### 9.5 権限エラー (Linux/macOS)

```bash
# backendディレクトリの権限を修正
sudo chown -R $USER:$USER backend/

# Laravelのストレージとキャッシュディレクトリに書き込み権限を付与
chmod -R 775 backend/storage backend/bootstrap/cache
```

### 9.6 Docker コンテナの完全リセット

全てをやり直したい場合:

```bash
# コンテナを停止・削除
docker compose down

# ボリュームも含めて完全削除
docker compose down -v

# Dockerイメージを削除
docker compose down --rmi all

# データベースデータを削除
rm -rf docker/postgres/data

# 再度起動
docker compose up -d --build
```

**重要**: 再ビルド後のマイグレーションについて

- `docker compose down` → `docker compose up -d --build` の場合:
  - データベースのボリュームは保持されるため、**マイグレーションは基本的に不要**です
  - ただし、新しいマイグレーションファイルが追加されている場合は実行が必要です
  - マイグレーション状態を確認: `docker compose exec app php artisan migrate:status`
  - 未実行のマイグレーションがあれば実行: `docker compose exec app php artisan migrate`

- `docker compose down -v` → `docker compose up -d --build` の場合:
  - ボリュームも削除されるため、**マイグレーションが必要**です
  - マイグレーション実行: `docker compose exec app php artisan migrate`
  - シーダーも実行する場合: `docker compose exec app php artisan migrate --seed`

### 9.7 CORS エラー

#### 問題: Access-Control-Allow-Origin エラー

フロントエンドからAPIを呼び出した際にCORSエラーが発生する場合:

```bash
# backend/config/cors.php の設定を確認
# 'allowed_origins' に 'http://localhost:3000' が含まれているか確認

# キャッシュをクリア
docker compose exec app php artisan config:clear

# Laravelを再起動
docker compose restart app nginx
```

### 9.8 Laravel Sanctum の認証エラー

#### 問題: 419 CSRF token mismatch

```bash
# backend/.env を確認
SESSION_DRIVER=redis
SESSION_DOMAIN=localhost
SANCTUM_STATEFUL_DOMAINS=localhost:3000

# セッションをクリア
docker compose exec app php artisan cache:clear

# フロントエンドで先にCSRFクッキーを取得
# await axios.get('/sanctum/csrf-cookie')
```

### 9.9 ホットリロードが動作しない (Vite)

#### 問題: ファイルを変更してもブラウザが自動更新されない

`frontend/vite.config.ts` を編集:

```typescript
export default defineConfig({
  plugins: [vue()],
  server: {
    port: 3000,
    host: true,
    watch: {
      usePolling: true,  // 追加
    },
    proxy: {
      '/api': {
        target: 'http://localhost:8000',
        changeOrigin: true,
      }
    }
  }
})
```

### 9.10 Windows でのパス区切り文字エラー

Windows PowerShellでは、パスの区切り文字が異なる場合があります:

```powershell
# バックスラッシュを使用
cd backend\storage

# またはフォワードスラッシュでも動作する場合が多い
cd backend/storage
```

---

## 10. 開発に役立つコマンド集

### 10.1 Laravel関連

```bash
# コントローラー作成
docker compose exec app php artisan make:controller UserController

# モデル作成（マイグレーション、ファクトリ、シーダー付き）
docker compose exec app php artisan make:model Subject -mfs

# リクエストクラス作成
docker compose exec app php artisan make:request StoreAssignmentRequest

# ポリシー作成
docker compose exec app php artisan make:policy SubmissionPolicy

# サービスクラス作成（手動でファイル作成）
# app/Services/SubmissionService.php

# ルート一覧表示
docker compose exec app php artisan route:list

# Tinker（対話型シェル）起動
docker compose exec app php artisan tinker
```

### 10.2 データベース関連

```bash
# マイグレーション状態確認
docker compose exec app php artisan migrate:status

# SQLログの有効化（AppServiceProviderに追記）
# DB::listen(function ($query) { Log::info($query->sql); });

# データベースのバックアップ
docker compose exec postgres pg_dump -U school_user school_assignment_db > backup.sql

# データベースのリストア
docker compose exec -T postgres psql -U school_user school_assignment_db < backup.sql
```

### 10.3 テスト関連

```bash
# テストクラス作成
docker compose exec app php artisan make:test UserTest
docker compose exec app php artisan make:test Api/SubmissionTest

# テスト実行
docker compose exec app php artisan test

# 特定のテストのみ実行
docker compose exec app php artisan test --filter=UserTest

# カバレッジレポート生成
docker compose exec app php artisan test --coverage
```

### 10.4 キャッシュ・最適化関連

```bash
# 全キャッシュクリア
docker compose exec app php artisan optimize:clear

# 設定キャッシュ
docker compose exec app php artisan config:cache

# ルートキャッシュ
docker compose exec app php artisan route:cache

# ビューキャッシュ
docker compose exec app php artisan view:cache
```

### 10.5 コード品質関連

```bash
# Laravel Pint（コードフォーマット）
docker compose exec app ./vendor/bin/pint

# PHPStan（静的解析）
docker compose exec app ./vendor/bin/phpstan analyse
```

---

## 11. 次のステップ

環境構築が完了したら、以下の手順で開発を進めます:

1. **データベース設計の実装**
   - マイグレーションファイルの詳細作成
   - モデルとリレーションの定義

2. **認証システムの実装**
   - Laravel Sanctumの設定
   - ユーザー登録・ログイン機能

3. **API開発**
   - RESTful APIエンドポイントの実装
   - バリデーションとエラーハンドリング

4. **フロントエンド開発**
   - コンポーネント設計
   - 画面実装
   - API連携

5. **テストの作成**
   - ユニットテスト
   - 機能テスト
   - E2Eテスト

6. **デプロイ準備**
   - 本番環境設定
   - CI/CDパイプライン構築

---

## 12. 環境構築チェックリスト

環境構築が正しく完了しているか、以下のチェックリストで確認してください。

### 12.1 ソフトウェアインストール

- [ ] Git がインストールされ、バージョンが確認できる
- [ ] Docker Desktop がインストールされ、起動している
- [ ] Node.js (v20) がインストールされている
- [ ] npm が動作する
- [ ] Visual Studio Code がインストールされている（推奨）

### 12.2 プロジェクトセットアップ

- [ ] プロジェクトディレクトリが作成されている
- [ ] Gitリポジトリが初期化されている
- [ ] .gitignore ファイルが作成されている
- [ ] 必要なディレクトリ構造が作成されている

### 12.3 Docker環境

- [ ] docker-compose.yml が作成されている
- [ ] docker/php/Dockerfile が作成されている
- [ ] docker/nginx/default.conf が作成されている
- [ ] docker compose ps で全てのコンテナが Up 状態
- [ ] docker compose logs でエラーが出ていない

### 12.4 バックエンド

- [ ] Laravel がインストールされている
- [ ] backend/.env ファイルが正しく設定されている
- [ ] APP_KEY が生成されている
- [ ] http://localhost:8000 でLaravelが表示される
- [ ] Laravel Sanctum がインストールされている
- [ ] CORS 設定が完了している
- [ ] データベース接続が成功する

### 12.5 フロントエンド

- [ ] Vue 3 プロジェクトが作成されている
- [ ] 必要なパッケージがインストールされている
- [ ] frontend/.env ファイルが作成されている
- [ ] http://localhost:3000 でVueアプリが表示される
- [ ] Vuetify がセットアップされている
- [ ] Vue Router がセットアップされている

### 12.6 データベース

- [ ] PostgreSQL コンテナが起動している
- [ ] psql コマンドでデータベースに接続できる
- [ ] マイグレーションが実行できる
- [ ] GUIツール（オプション）で接続できる

### 12.7 その他のサービス

- [ ] Redis コンテナが起動している
- [ ] redis-cli で接続できる
- [ ] Mailpit (http://localhost:8025) にアクセスできる

---

## 13. 本番環境への移行準備

開発環境構築後、本番環境へのデプロイを見据えた準備について説明します。

### 13.1 環境変数の管理

本番環境では、`.env` ファイルの内容を適切に変更する必要があります。

#### 変更が必要な主な項目:

```env
APP_ENV=production
APP_DEBUG=false
APP_URL=https://your-production-domain.com

DB_HOST=<本番DBホスト>
DB_DATABASE=<本番DB名>
DB_USERNAME=<本番DBユーザー>
DB_PASSWORD=<強固なパスワード>

CACHE_DRIVER=redis
SESSION_DRIVER=redis
QUEUE_CONNECTION=redis

MAIL_HOST=<本番SMTPサーバー>
MAIL_PORT=587
MAIL_USERNAME=<メールアカウント>
MAIL_PASSWORD=<メールパスワード>
MAIL_ENCRYPTION=tls
```

### 13.2 セキュリティ設定

本番環境では以下のセキュリティ設定が必須です:

* HTTPS の有効化（SSL/TLS証明書の取得）
* 強固なパスワードの使用
* ファイアウォールの設定
* 不要なポートのクローズ
* セキュリティヘッダーの設定
* レート制限の有効化

### 13.3 パフォーマンス最適化

本番環境では以下の最適化を実施:

```bash
# Laravel の最適化
php artisan config:cache
php artisan route:cache
php artisan view:cache
php artisan optimize

# フロントエンドのビルド
npm run build
```

### 13.4 監視とロギング

本番環境では監視とロギングの設定が重要です:

* アプリケーションログの適切な出力先設定
* エラー監視ツール（Sentry等）の導入
* パフォーマンス監視の設定
* アラート設定

### 13.5 バックアップ戦略

* データベースの定期バックアップ（日次推奨）
* ファイルストレージのバックアップ
* バックアップの自動化
* リストアテストの実施

---

## 14. 参考リンク

* [Laravel公式ドキュメント](https://laravel.com/docs)
* [Vue.js公式ドキュメント](https://vuejs.org/)
* [Vuetify公式ドキュメント](https://vuetifyjs.com/)
* [Docker公式ドキュメント](https://docs.docker.com/)
* [PostgreSQL公式ドキュメント](https://www.postgresql.org/docs/)
* [Laravel Sanctum公式ドキュメント](https://laravel.com/docs/sanctum)
* [Vite公式ドキュメント](https://vitejs.dev/)
* [Pinia公式ドキュメント](https://pinia.vuejs.org/)

---

## 付録: よくある質問（FAQ）

### Q1: 開発環境と本番環境の違いは？

開発環境ではDockerを使用し、Mailpitなどのモックサービスを使用します。本番環境では、実際のSMTPサーバーやクラウドストレージを使用します。また、本番環境ではHTTPS必須、デバッグモードOFF、キャッシュ有効化など、セキュリティとパフォーマンスの設定が異なります。

### Q2: Dockerを使わずに開発できますか？

可能ですが、PHP、PostgreSQL、Redis、Nginxを個別にインストールする必要があります。Dockerを使用することで環境の統一と再現性が保証され、チーム開発での環境差異によるトラブルを防げます。

### Q3: Windows環境でのパフォーマンス問題

WSL 2を使用することで大幅に改善されます。Docker DesktopでWSL 2バックエンドを有効にしてください。また、プロジェクトをWSL 2のファイルシステム内に配置することで、さらにパフォーマンスが向上します。

### Q4: データベースのGUIツールは使えますか？

はい。pgAdmin、DBeaver、TablePlusなどのツールで `localhost:5432` に接続できます。接続情報は docker-compose.yml に記載されています（ユーザー: school_user、パスワード: school_password）。

### Q5: 本番環境へのデプロイ方法は？

別途「デプロイ手順書」を参照してください。AWS、GCP、Azureなど、様々なクラウドプラットフォームにデプロイ可能です。Docker Composeを使用しているため、コンテナベースのデプロイが推奨されます。

### Q6: Laravelのマイグレーションをやり直したい

```bash
# 全てのマイグレーションをロールバックして再実行
docker compose exec app php artisan migrate:fresh

# データも含めて再作成（シーダー実行）
docker compose exec app php artisan migrate:fresh --seed
```

**注意**: 全データが削除されるので、本番環境では絶対に実行しないでください。

### Q7: フロントエンドとバックエンドの通信がうまくいかない

以下を確認してください:

1. バックエンドのCORS設定（config/cors.php）
2. Sanctumの設定（config/sanctum.php）
3. .envの SESSION_DOMAIN と SANCTUM_STATEFUL_DOMAINS
4. フロントエンドで先に /sanctum/csrf-cookie を取得しているか
5. axios の withCredentials が true になっているか

### Q8: Dockerコンテナのログを確認したい

```bash
# 全コンテナのログを表示
docker compose logs

# 特定のコンテナのログを表示
docker compose logs app

# リアルタイムでログを追跡
docker compose logs -f app

# 最新の50行のみ表示
docker compose logs --tail=50 app
```

### Q9: Node.jsのバージョンを変更したい

```bash
# nvmを使用してバージョンを変更
nvm install 18
nvm use 18

# または
nvm install 20
nvm use 20

# プロジェクトのnode_modulesを再インストール
cd frontend
rm -rf node_modules package-lock.json
npm install
```

### Q10: Docker Desktopのディスク使用量が多すぎる

```bash
# 使用していないイメージ、コンテナ、ボリュームを削除
docker system prune -a

# ビルドキャッシュも削除
docker builder prune

# 未使用のボリュームを削除
docker volume prune
```

**警告**: このコマンドは他のプロジェクトのデータも削除する可能性があるので注意してください。

---

**環境構築は以上です。何か問題が発生した場合は、トラブルシューティングのセクションを参照するか、開発チームに問い合わせてください。**

**次のステップ**: 環境構築が完了したら、「11. 次のステップ」セクションを参照して、データベース設計と実装に進んでください。
