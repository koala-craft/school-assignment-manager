# 学校提出物管理アプリ 動作確認手順書

本手順書では、API および各機能の動作確認方法を説明します。開発者・テスター・引き継ぎ担当者が、何をどのように確認すればよいかを把握できることを目的としています。

---

## 目次

1. [前提条件](#1-前提条件)
2. [動作確認の全体像](#2-動作確認の全体像)
3. [自動テストスクリプトによる確認](#3-自動テストスクリプトによる確認)
4. [手動確認（ブラウザ・curl）](#4-手動確認ブラウザcurl)
5. [テスト用アカウント](#5-テスト用アカウント)
6. [各APIの確認観点](#6-各apiの確認観点)
7. [トラブルシューティング](#7-トラブルシューティング)

---

## 1. 前提条件

### 1.1 環境構築の完了

動作確認を行う前に、以下が完了している必要があります。

- [環境構築手順書](./環境構築手順書.md) に従い、Docker コンテナが起動していること
- `docker compose up -d` でバックエンドが稼働していること
- マイグレーション・シーダーが実行済みであること（`php artisan migrate:fresh --seed`）

### 1.2 必要なソフトウェア

| ソフトウェア | 用途 |
|-------------|------|
| PowerShell 5.1 以上 | テストスクリプトの実行（Windows） |
| curl または Postman | 手動API確認（任意） |
| ブラウザ | フロントエンド・Mailpit の確認 |

### 1.3 機能別の設定

各機能（個人成績表PDF、パスワードリセットなど）の動作確認に必要な設定は [開発時の注意事項](./開発時の注意事項.md) を参照してください。

---

## 2. 動作確認の全体像

### 2.1 確認方法の種類

| 方法 | 対象 | 実行タイミング |
|------|------|----------------|
| **自動テストスクリプト** | 各API | 開発中・リリース前・回帰テスト |
| **手動確認（curl/Postman）** | 特定API | デバッグ・仕様確認 |
| **ブラウザ確認** | フロントエンド・Mailpit | 統合確認 |

### 2.2 推奨フロー

1. **初回セットアップ後**: 全テストスクリプトを実行して環境が正常か確認
2. **機能開発後**: 該当APIのテストスクリプトを実行
3. **リリース前**: 全テストスクリプトを実行して回帰確認

---

## 3. 自動テストスクリプトによる確認

### 3.1 概要

プロジェクトルートの `scripts/` ディレクトリに、API の動作確認用 PowerShell スクリプトがあります。各スクリプトは管理者アカウントでログインし、該当 API を呼び出して結果を検証します。

### 3.2 実行方法

**プロジェクトルート**で以下を実行してください。

```powershell
# 個別実行（例：認証API）
.\scripts\test-api.ps1

# 個別実行（例：ユーザー管理API）
.\scripts\test-user-api.ps1
```

**PowerShell の実行ポリシーエラーが出る場合**:

```powershell
Set-ExecutionPolicy RemoteSigned -Scope CurrentUser
```

### 3.3 利用可能なテストスクリプト一覧

| スクリプト | 確認対象 | 主な確認内容 |
|-----------|---------|-------------|
| `test-api.ps1` | 認証API | ログイン、/me 取得、ログアウト |
| `test-user-api.ps1` | ユーザー管理API | 一覧・作成・更新・削除 |
| `test-academic-api.ps1` | 年度・学期API | 年度・学期の CRUD |
| `test-subject-api.ps1` | 科目API | 科目の CRUD、教員割当 |
| `test-assignment-api.ps1` | 課題API | 課題の CRUD、公開・非公開 |
| `test-file-api.ps1` | ファイルAPI | アップロード・ダウンロード |
| `test-notification-api.ps1` | 通知API | 一覧・既読 |
| `test-report-api.ps1` | レポートAPI | CSV 出力 |
| `test-student-grades-pdf.ps1` | 個人成績表PDF | PDF ダウンロード |
| `test-dashboard-api.ps1` | ダッシュボードAPI | 管理・教員・学生ダッシュボード |
| `test-system-settings-api.ps1` | システム設定API | 取得・更新 |
| `test-audit-log-api.ps1` | 監査ログAPI | 一覧・詳細・フィルタ |
| `test-backup-api.ps1` | バックアップAPI | バックアップ実行・一覧取得 |

### 3.4 全スクリプト一括実行（推奨）

リリース前や環境構築後の確認では、全スクリプトを順に実行することを推奨します。

```powershell
# プロジェクトルートで実行
.\scripts\test-api.ps1
.\scripts\test-user-api.ps1
.\scripts\test-academic-api.ps1
.\scripts\test-subject-api.ps1
.\scripts\test-assignment-api.ps1
.\scripts\test-file-api.ps1
.\scripts\test-notification-api.ps1
.\scripts\test-report-api.ps1
.\scripts\test-system-settings-api.ps1
.\scripts\test-audit-log-api.ps1
.\scripts\test-backup-api.ps1
.\scripts\test-student-grades-pdf.ps1
.\scripts\test-dashboard-api.ps1
.\scripts\test-password-reset-api.ps1
```

**注意**: 実行順序は依存関係に影響します。`test-subject-api.ps1` などは年度・学期が作成済みである必要があります。上記の順番で実行すれば問題ありません。

### 3.5 成功時の出力例

```
=== User Management API Test ===

[1/7] Testing Admin Login...
  ✓ Login successful (Token: 1|abcdef...)

[2/7] Testing GET /api/admin/users...
  ✓ Retrieved 5 users

...

=== All User Management API Tests Passed! ===
```

### 3.6 失敗時の出力例

```
Error: The remote server returned an error: (401) Unauthorized.
```

この場合は、[トラブルシューティング](#7-トラブルシューティング) を参照してください。

---

## 4. 手動確認（ブラウザ・curl）

### 4.1 ヘルスチェック

```bash
curl http://localhost:8000/api/health
```

期待されるレスポンス例:

```json
{"status":"ok","timestamp":"2024-01-15T10:00:00+00:00"}
```

### 4.2 認証フロー（curl 例）

```bash
# 1. ログイン
curl -X POST http://localhost:8000/api/auth/login \
  -H "Content-Type: application/json" \
  -H "Accept: application/json" \
  -d '{"email":"admin@school.local","password":"password"}'

# 2. レスポンスの token をコピーし、以下で /me 取得
curl -X GET http://localhost:8000/api/auth/me \
  -H "Authorization: Bearer <token>" \
  -H "Accept: application/json"
```

### 4.3 ブラウザでの確認

| URL | 用途 |
|-----|------|
| http://localhost:8000 | バックエンド（Laravel ウェルカムページ） |
| http://localhost:3000 | フロントエンド（Vue アプリ） |
| http://localhost:8000/telescope | Telescope（デバッグツール） |
| http://localhost:8025 | Mailpit（メールテスト） |

---

## 5. テスト用アカウント

シーダー実行後に以下のアカウントが利用可能です。いずれもパスワードは `password` です。

| メールアドレス | ロール | 用途 |
|---------------|--------|------|
| admin@school.local | admin | 管理者向けテスト（全API） |
| teacher@school.local | teacher | 教員向けテスト |
| student.admin@school.local | student_admin | 管理者学生向けテスト |
| student@school.local | student | 一般学生向けテスト |

---

## 6. 各APIの確認観点

詳細な API 仕様は [API仕様書](./API仕様書.md) を参照してください。ここでは、動作確認時に特に注意すべき点をまとめます。

### 6.1 認証API

- ログイン成功時にトークンが返ること
- 無効化されたユーザーはログインできないこと
- トークン付きで /me が取得できること
- ログアウト後にトークンが無効になること

### 6.2 ユーザー管理API

- 管理者のみアクセス可能なこと
- 検索・フィルタ・ページネーションが動作すること
- パスワードはレスポンスに含まれないこと

### 6.3 監査ログAPI

- ログイン後に監査ログに login が記録されること
- 一覧・詳細・フィルタ（user_id, action, model, date_from, date_to）が動作すること

### 6.4 その他

- 権限のないエンドポイントへのアクセスで 403 が返ること
- 存在しないリソースへのアクセスで 404 が返ること

---

## 7. トラブルシューティング

### 7.1 接続エラー（Connection refused）

- Docker コンテナが起動しているか確認: `docker compose ps`
- バックエンドが 8000 番ポートで待ち受けているか確認

### 7.2 401 Unauthorized

- シーダーが実行されているか確認: `docker compose exec app php artisan db:seed`
- メールアドレス・パスワードが正しいか確認（admin@school.local / password）
- トークンの有効期限切れの可能性（再ログイン）

### 7.3 403 Forbidden

- 管理者専用 API には admin アカウントでログインすること
- 教員・学生専用 API には該当ロールのアカウントを使用すること

### 7.4 404 Not Found

- 対象リソース（ユーザー・科目・課題など）が存在するか確認
- シーダーで初期データが投入されているか確認

### 7.5 テストスクリプトの実行順序

一部のテストは他 API で作成したデータに依存します。初回実行時は次の順序を推奨します。

1. test-api.ps1
2. test-user-api.ps1
3. test-academic-api.ps1
4. test-subject-api.ps1
5. その他

---

## 8. 設計書類との対応

| 設計書 | 関連するテストスクリプト |
|-------|-------------------------|
| [API仕様書](./API仕様書.md) | 全 test-*.ps1 |
| [DB設計書](./DB設計書.md) | 全 test-*.ps1（データ操作確認） |
| [環境構築手順書](./環境構築手順書.md) | 本手順書の前提条件 |
| [開発時の注意事項](./開発時の注意事項.md) | 各機能の動作確認に必要な設定 |

---

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2026-02-11 | 初版作成 |
