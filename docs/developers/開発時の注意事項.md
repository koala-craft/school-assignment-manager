# 開発時の注意事項

本プロジェクトで開発・動作確認を行う際に必要な設定をまとめています。新規参加者や環境構築時に参照してください。

---

## 一覧

| 機能 | 設定内容 |
|------|----------|
| [個人成績表PDF](#個人成績表pdf) | composer update |
| [パスワードリセット](#パスワードリセット) | FRONTEND_URL、Mailpit |
| [ログインが遅い場合](#ログインが遅い場合) | SESSION_DRIVER、ブラウザコンソール計測 |
| 監査ログAPI | 特になし |
| ダッシュボードAPI | 特になし |
| [バックアップAPI](#バックアップapi) | Docker 再ビルド |

---

## 個人成績表PDF

### 初回のみ

DomPDF パッケージを追加しているため、以下を実行してください。

```bash
docker compose exec app composer update
```

---

## パスワードリセット

### .env の設定

- **FRONTEND_URL**: フロントエンドのURLを設定（メール内のリセットリンク先）
  - 例: `FRONTEND_URL=http://localhost:3000`
  - 未設定時は `http://localhost:3000` がデフォルト

### メールの確認

- 開発時は **Mailpit** でメールを確認できます
- URL: http://localhost:8025
- パスワードリセット要求後、メールが送信されるため Mailpit が起動していること

### テスト時の注意

- `scripts/test-password-reset-api.ps1` 実行時、Mailpit が起動している必要があります
- 実際のリセット実行テストは、Mailpit でメールを確認し、リンク内の token を取得してから `POST /api/auth/password/reset` を呼んでください

---

## ログインが遅い場合

### 原因の確認

開発時、ログイン後にブラウザの開発者ツール（F12）→ コンソールを開くと、`[auth] CSRF: X ms, Login: Y ms, Total: Z ms` のように計測結果が表示されます。**Login** の時間が長い場合はバックエンド（Laravel/DB）側、**CSRF** が長い場合はセッションや初回リクエストの遅延が考えられます。

### 対処

- **SESSION_DRIVER**: `APP_ENV=local` のときはデフォルトで `file` になり、DB セッションの往復がなくなるためログインが速くなりやすいです。`.env` で `SESSION_DRIVER=database` にしている場合は、開発時だけ `SESSION_DRIVER=file` に変更して試してください。
- **ログイン画面を開いたまま数秒待ってからログイン**すると、CSRF が事前取得済みのため、ボタン押下後の待ち時間が短くなります。
- Docker 利用時は、コンテナ起動直後の初回リクエストは特に遅くなりやすいです。2 回目以降は速くなることもあります。

---

## 監査ログAPI

特になし。マイグレーション実行後、そのまま利用可能です。

---

## ダッシュボードAPI

特になし。監査ログAPI が実装済みであれば、recent_activities も含めて動作します。

---

## バックアップAPI

### 初回のみ（postgresql-client 追加のため）

Docker イメージを再ビルドしてください。

```bash
docker compose build app --no-cache
docker compose up -d
```

---

## 関連ドキュメント

| ドキュメント | 内容 |
|-------------|------|
| [環境構築手順書](./環境構築手順書.md) | 開発環境の構築手順 |
| [動作確認手順書](./動作確認手順書.md) | API・機能の動作確認手順 |
| [API仕様書](./API仕様書.md) | 各 API の仕様 |

---

## 更新ルール

新機能を実装した際、本ファイルに「開発時にこうしてください」という注意事項があれば、該当セクションを追加・更新してください。
