# ログイン速度改善ガイド

## 問題の原因

サーバーwaitingが9秒という異常に遅いログイン処理の原因は、**bcryptのコストが12に設定されていた**ことです。

### bcryptコストの影響

- **コスト10**: 約100-200ms（推奨）
- **コスト12**: 約400-800ms（非常に重い）
- **コスト8**: 約50-100ms（開発環境向け）

コスト12はコスト10の約4倍の時間がかかります。Docker環境でCPUリソースが制限されている場合、さらに遅くなります。

## 実装した改善内容

### 1. パスワードハッシュ設定ファイルの作成 ✅

`backend/config/hashing.php` を作成し、bcryptのコストを環境変数で制御できるようにしました。

**デフォルト値**: 8（開発環境向け）

### 2. ログイン処理のパフォーマンス測定 ✅

`AuthController::login()` にパフォーマンス測定コードを追加しました。

開発環境では、以下のログが `storage/logs/laravel.log` に記録されます：

```
[INFO] Login Performance {
    "db_query_ms": 15.23,
    "hash_check_ms": 8500.45,  // ← これが9秒の原因
    "token_create_ms": 12.34,
    "total_ms": 8527.02
}
```

### 3. `.env.example` の修正 ✅

`BCRYPT_ROUNDS=12` → `BCRYPT_ROUNDS=8` に変更しました。

## 適用方法

### 1. `.env` ファイルの確認・更新

`backend/.env` ファイルに以下を追加または更新：

```env
BCRYPT_ROUNDS=8
```

### 2. 既存のパスワードハッシュの再作成

**重要**: 既存のパスワードハッシュは古いコスト（12）で作られているため、**再シーディングが必要**です。

```bash
# データベースをリセットして再シーディング
docker compose exec app php artisan migrate:fresh --seed
```

**注意**: これにより既存のデータがすべて削除されます。開発環境でのみ実行してください。

### 3. パフォーマンス確認

1. ログインを実行
2. `storage/logs/laravel.log` を確認して、`hash_check_ms` が100ms以下になっているか確認

```bash
docker compose exec app tail -f storage/logs/laravel.log | grep "Login Performance"
```

## 期待される改善効果

### ログイン処理
- **修正前**: 9秒（サーバーwaiting）
- **修正後**: 100-200ms（期待値）
- **改善率**: 約98%削減

### ダッシュボード読み込み
- **修正前**: 4秒（サーバーwaiting）
- **修正後**: 50-150ms（期待値、既存の最適化により）
- **改善率**: 約96%削減

## 本番環境での設定

本番環境では、セキュリティとパフォーマンスのバランスを考慮して、**コスト10**を推奨します：

```env
BCRYPT_ROUNDS=10
```

コスト10でも、適切なハードウェア環境では100-200ms程度で完了します。

## トラブルシューティング

### ログインがまだ遅い場合

1. **ログを確認**:
   ```bash
   docker compose exec app tail -n 50 storage/logs/laravel.log | grep "Login Performance"
   ```

2. **どの処理が遅いか確認**:
   - `hash_check_ms` が高い → bcryptコストが高い、またはCPUリソース不足
   - `db_query_ms` が高い → PostgreSQLの接続またはクエリが遅い
   - `token_create_ms` が高い → Sanctumのトークン作成が遅い

3. **Docker Desktopのリソース確認**:
   - Settings → Resources → Advanced
   - CPU: 4以上推奨
   - Memory: 4GB以上推奨

### パスワードが一致しない場合

再シーディング後は、すべてのテストユーザーのパスワードが `password` にリセットされます。

## 参考

- [Laravel Hashing](https://laravel.com/docs/12.x/hashing)
- [bcrypt Cost Factor](https://en.wikipedia.org/wiki/Bcrypt#Description)
