# パフォーマンス改善実装レポート

## 実装した改善内容

### 1. DashboardController::teacher() - totalStudents の改善 ✅

**修正前:**
```php
$totalStudents = Enrollment::whereIn('subject_id', $subjectIds)
    ->where('is_active', true)
    ->pluck('student_id')  // 全レコードをメモリに読み込み
    ->unique()             // メモリ上でユニーク化
    ->count();
```

**修正後:**
```php
$totalStudents = Enrollment::whereIn('subject_id', $subjectIds)
    ->where('is_active', true)
    ->distinct('student_id')  // DBレベルでユニーク化
    ->count('student_id');
```

**効果:**
- メモリ使用量の削減
- クエリ実行時間の短縮（特に大量データの場合）

### 2. DashboardController::getSubmissionStats() の改善 ✅

**修正前:**
```php
$total = Submission::count();  // クエリ1
$submitted = Submission::whereIn('status', [...])->count();  // クエリ2
$notSubmitted = $total - $submitted;
$overdue = Submission::overdue()->count();  // クエリ3
```

**修正後:**
```php
$stats = Submission::selectRaw('
    COUNT(*) as total,
    SUM(CASE WHEN status IN (...) THEN 1 ELSE 0 END) as submitted,
    SUM(CASE WHEN is_overdue = true THEN 1 ELSE 0 END) as overdue
')->first();  // 1つのクエリで集約
```

**効果:**
- クエリ数を4つから1つに削減
- テーブルスキャン回数の削減

### 3. whereHas の使用を減らす ✅

#### DashboardController::teacher()

**修正前:**
```php
$pendingGrading = Submission::needsGrading()
    ->whereHas('assignment', fn ($q) => $q->whereIn('subject_id', $subjectIds))
    ->count();

$recentSubmissions = Submission::with(['assignment.subject', 'student'])
    ->whereHas('assignment', fn ($q) => $q->whereIn('subject_id', $subjectIds))
    ->whereIn('status', ['submitted', 'resubmitted'])
    ->get();
```

**修正後:**
```php
$assignmentIds = Assignment::whereIn('subject_id', $subjectIds)->pluck('id');
$pendingGrading = Submission::needsGrading()
    ->whereIn('assignment_id', $assignmentIds)
    ->count();

$recentSubmissions = Submission::with(['assignment.subject', 'student'])
    ->whereIn('assignment_id', $assignmentIds)
    ->whereIn('status', ['submitted', 'resubmitted'])
    ->get();
```

#### DashboardController::student()

**修正前:**
```php
$submissions = Submission::where('student_id', $user->id)
    ->whereHas('assignment', fn ($q) => $q->whereIn('subject_id', $subjectIds));
```

**修正後:**
```php
$assignmentIds = Assignment::whereIn('subject_id', $subjectIds)
    ->active()
    ->whereNotNull('published_at')
    ->where('published_at', '<=', now())
    ->pluck('id');

$submissions = Submission::where('student_id', $user->id)
    ->whereIn('assignment_id', $assignmentIds);
```

#### SubmissionController::index()

**修正前:**
```php
$subjectIds = $request->user()->taughtSubjects()->pluck('id');
$query->whereHas('assignment', fn ($q) => $q->whereIn('subject_id', $subjectIds));
```

**修正後:**
```php
$subjectIds = $request->user()->taughtSubjects()->pluck('id');
$assignmentIds = \App\Models\Assignment::whereIn('subject_id', $subjectIds)->pluck('id');
$query->whereIn('assignment_id', $assignmentIds);
```

**効果:**
- サブクエリの削減
- JOINの最適化による実行時間の短縮

### 4. SubmissionController::bulkCreate() の改善 ✅

**修正前:**
```php
foreach ($assignment->subject->students as $student) {
    $existing = Submission::where('assignment_id', $assignmentId)
        ->where('student_id', $student->id)
        ->exists();  // N+1クエリ
    
    if (!$existing) {
        Submission::create([...]);  // N回のINSERT
    }
}
```

**修正後:**
```php
$studentIds = $assignment->subject->students->pluck('id');
$existingSubmissions = Submission::where('assignment_id', $assignmentId)
    ->whereIn('student_id', $studentIds)
    ->pluck('student_id')
    ->toArray();  // 1つのクエリで一括取得

$newStudentIds = $studentIds->diff($existingSubmissions);

if ($newStudentIds->isNotEmpty()) {
    $insertData = $newStudentIds->map(function ($studentId) use ($assignmentId) {
        return [...];
    })->toArray();
    
    Submission::insert($insertData);  // 1回の一括INSERT
}
```

**効果:**
- N+1クエリの解消
- 大量データでの大幅なパフォーマンス向上

### 5. 複合インデックスの追加 ✅

以下のインデックスを追加するマイグレーションを作成：

1. **submissions テーブル**
   - `idx_submissions_student_status`: `student_id` + `status`
   - `idx_submissions_assignment_status`: `assignment_id` + `status`

2. **enrollments テーブル**
   - `idx_enrollments_subject_active`: `subject_id` + `is_active`

3. **assignments テーブル**
   - `idx_assignments_subject_active_published`: `subject_id` + `is_active` + `published_at`
   - `idx_assignments_subject_deadline`: `subject_id` + `deadline`

4. **audit_logs テーブル**
   - `idx_audit_logs_user_created`: `user_id` + `created_at`

**効果:**
- WHERE句とORDER BY句のパフォーマンス向上
- インデックススキャンによる高速化

## パフォーマンス測定方法

### 1. マイグレーション実行
```bash
php artisan migrate
```

### 2. パフォーマンステストエンドポイントを使用

開発環境で以下のエンドポイントにアクセス：
```
GET /api/performance/test-dashboard
```

レスポンスには以下の情報が含まれます：
- `total_time_ms`: 総実行時間（ミリ秒）
- `query_count`: 実行されたクエリ数
- `query_time_ms`: クエリ実行時間の合計（ミリ秒）
- `queries`: 各クエリの詳細（時間、SQL、バインディング）

### 3. Telescopeで確認

Laravel Telescopeが有効な場合、`/telescope` にアクセスしてクエリの詳細を確認できます。

### 4. ログで確認

`storage/logs/laravel.log` にクエリパフォーマンス情報が記録されます。

## 期待される改善効果

### クエリ数の削減
- **修正前**: ダッシュボード1回あたり 10-15クエリ
- **修正後**: ダッシュボード1回あたり 5-8クエリ
- **削減率**: 約40-50%

### 実行時間の短縮
- **修正前**: 100-300ms（データ量による）
- **修正後**: 50-150ms（データ量による）
- **改善率**: 約50%

### メモリ使用量の削減
- `pluck()->unique()->count()` の改善により、大量データでのメモリ使用量を削減

## 次のステップ

1. 実際のデータでパフォーマンス測定を実施
2. 必要に応じて追加の最適化を検討
3. キャッシュ戦略の検討（既にフロントエンドで実装済み）
